<!-- ============================================
     üîî MODAL DE NOTIFICACIONES - ECOPUNTOS
     ============================================ -->

<!-- Modal para mostrar notificaci√≥n autom√°tica -->
<div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content notification-modal-content">
            <div class="modal-header notification-modal-header">
                <div class="notification-modal-icon-container">
                    <i class="fas fa-bell notification-modal-icon"></i>
                </div>
                <h5 class="modal-title notification-modal-title" id="notificationModalLabel">
                    Nueva Notificaci√≥n
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body notification-modal-body">
                <div class="notification-content">
                    <h6 class="notification-title" id="modalNotificationTitle">
                        <!-- T√≠tulo de la notificaci√≥n -->
                    </h6>
                    <p class="notification-message" id="modalNotificationMessage">
                        <!-- Mensaje de la notificaci√≥n -->
                    </p>
                    <div class="notification-motivo" id="modalNotificationMotivo" style="display: none;">
                        <div class="motivo-label">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Motivo:</strong>
                        </div>
                        <p class="motivo-text" id="modalNotificationMotivoText">
                            <!-- Motivo del reagendamiento u otro detalle -->
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer notification-modal-footer">
                <button type="button" class="btn btn-primary btn-accept-notification" id="acceptNotificationBtn">
                    <i class="fas fa-check me-2"></i>Aceptar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* ============================================
   ESTILOS DEL MODAL DE NOTIFICACIONES
   ============================================ */

.notification-modal-content {
    border: none;
    border-radius: 1rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    overflow: hidden;
}

.notification-modal-header {
    background: linear-gradient(135deg, var(--primary, #10b981) 0%, var(--primary-dark, #059669) 100%);
    color: white;
    border-bottom: none;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.notification-modal-icon-container {
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: pulse 2s ease-in-out infinite;
}

.notification-modal-icon {
    font-size: 1.5rem;
    color: white;
}

.notification-modal-title {
    margin: 0;
    font-weight: 600;
    flex: 1;
}

.notification-modal-body {
    padding: 2rem;
    background: white;
}

.notification-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.notification-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary, #1f2937);
    margin: 0;
    line-height: 1.4;
}

.notification-message {
    font-size: 1rem;
    color: var(--text-secondary, #6b7280);
    margin: 0;
    line-height: 1.6;
}

.notification-motivo {
    margin-top: 0.5rem;
    padding: 1rem;
    background: #fef3c7;
    border-left: 4px solid #f59e0b;
    border-radius: 0.5rem;
}

.motivo-label {
    display: flex;
    align-items: center;
    color: #92400e;
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
}

.motivo-text {
    margin: 0;
    color: #78350f;
    font-size: 0.95rem;
    line-height: 1.5;
}

.notification-modal-footer {
    background: #f9fafb;
    border-top: 1px solid #e5e7eb;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: flex-end;
}

.btn-accept-notification {
    padding: 0.625rem 1.5rem;
    font-weight: 600;
    border-radius: 0.5rem;
    background: var(--primary, #10b981);
    border: none;
    color: white;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-accept-notification:hover {
    background: var(--primary-dark, #059669);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.btn-accept-notification:active {
    transform: translateY(0);
}

/* Animaciones */
@keyframes pulse {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.05);
        opacity: 0.8;
    }
}

/* Responsive */
@media (max-width: 576px) {
    .notification-modal-body {
        padding: 1.5rem;
    }
    
    .notification-title {
        font-size: 1.1rem;
    }
    
    .notification-message {
        font-size: 0.95rem;
    }
    
    .notification-modal-header {
        padding: 1.25rem;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .notification-modal-body {
        background: #1f2937;
    }
    
    .notification-title {
        color: #f9fafb;
    }
    
    .notification-message {
        color: #d1d5db;
    }
    
    .notification-modal-footer {
        background: #111827;
        border-top-color: #374151;
    }
}

/* Loading state */
.notification-modal-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    color: var(--text-secondary, #6b7280);
}

.notification-modal-loading i {
    margin-right: 0.5rem;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}
</style>

<script>
/**
 * Sistema de Modal de Notificaciones Autom√°tico
 * Carga y muestra la notificaci√≥n no le√≠da m√°s reciente al entrar al dashboard
 */
(function() {
    'use strict';
    
    // Variables globales del modal
    let currentNotificationId = null;
    let notificationModal = null;
    let isProcessing = false;
    
    /**
     * Inicializa el sistema de modal de notificaciones
     */
    function initNotificationModal() {
        // Esperar a que el DOM est√© completamente cargado
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadAndShowNotification);
        } else {
            loadAndShowNotification();
        }
    }
    
    /**
     * Carga y muestra la notificaci√≥n m√°s reciente si existe
     */
    async function loadAndShowNotification() {
        try {
            // Obtener el modal
            const modalElement = document.getElementById('notificationModal');
            if (!modalElement) {
                console.warn('Modal de notificaciones no encontrado en el DOM');
                return;
            }
            
            // Inicializar el modal de Bootstrap
            notificationModal = new bootstrap.Modal(modalElement, {
                backdrop: 'static',
                keyboard: false
            });
            
            // Agregar evento al bot√≥n de aceptar
            const acceptBtn = document.getElementById('acceptNotificationBtn');
            if (acceptBtn) {
                acceptBtn.addEventListener('click', handleAcceptNotification);
            }
            
            // Cargar la notificaci√≥n m√°s reciente
            const response = await fetch('/api/notifications/latest-unread/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                console.error('Error al obtener notificaci√≥n:', response.status);
                return;
            }
            
            const data = await response.json();
            
            if (data.success && data.has_notification && data.notification) {
                // Verificar si esta notificaci√≥n ya fue mostrada en esta sesi√≥n
                const notifId = data.notification.id;
                const shownKey = `notification_shown_${notifId}`;
                const alreadyShown = sessionStorage.getItem(shownKey);
                
                if (!alreadyShown) {
                    // Mostrar la notificaci√≥n en el modal
                    showNotificationInModal(data.notification);
                    
                    // Marcar como mostrada en esta sesi√≥n
                    sessionStorage.setItem(shownKey, 'true');
                } else {
                    console.log('Notificaci√≥n ya mostrada en esta sesi√≥n');
                }
            } else {
                console.log('No hay notificaciones pendientes');
            }
            
        } catch (error) {
            console.error('Error al cargar notificaci√≥n:', error);
        }
    }
    
    /**
     * Muestra la notificaci√≥n en el modal
     */
    function showNotificationInModal(notification) {
        currentNotificationId = notification.id;
        
        // Actualizar el contenido del modal
        const titleElement = document.getElementById('modalNotificationTitle');
        const messageElement = document.getElementById('modalNotificationMessage');
        const motivoContainer = document.getElementById('modalNotificationMotivo');
        const motivoText = document.getElementById('modalNotificationMotivoText');
        
        if (titleElement) titleElement.textContent = notification.titulo || 'Notificaci√≥n';
        if (messageElement) messageElement.textContent = notification.mensaje || '';
        
        // Mostrar motivo si existe
        if (notification.motivo && motivoContainer && motivoText) {
            motivoText.textContent = notification.motivo;
            motivoContainer.style.display = 'block';
        } else if (motivoContainer) {
            motivoContainer.style.display = 'none';
        }
        
        // Actualizar el √≠cono seg√∫n el tipo
        updateModalIcon(notification.tipo_original || notification.tipo);
        
        // Mostrar el modal
        if (notificationModal) {
            notificationModal.show();
            
            // Analytics
            trackNotificationView(notification);
        }
    }
    
    /**
     * Actualiza el √≠cono del modal seg√∫n el tipo de notificaci√≥n
     */
    function updateModalIcon(tipo) {
        const iconElement = document.querySelector('.notification-modal-icon');
        const headerElement = document.querySelector('.notification-modal-header');
        
        if (!iconElement || !headerElement) return;
        
        // Remover clases anteriores
        iconElement.className = 'fas notification-modal-icon';
        
        // Asignar √≠cono y color seg√∫n el tipo
        let iconClass = 'fa-bell';
        let gradientColor = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        
        switch (tipo) {
            case 'canje_aprobado':
            case 'redencion_aprobada':
            case 'ruta_confirmada':
                iconClass = 'fa-check-circle';
                gradientColor = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                break;
            case 'canje_rechazado':
            case 'redencion_rechazada':
            case 'ruta_rechazada':
                iconClass = 'fa-times-circle';
                gradientColor = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                break;
            case 'canje_pendiente':
            case 'redencion_pendiente':
                iconClass = 'fa-clock';
                gradientColor = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                break;
            case 'ruta_reagendada':
                iconClass = 'fa-calendar-alt';
                gradientColor = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                break;
            case 'recompensa_canjeada':
                iconClass = 'fa-gift';
                gradientColor = 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)';
                break;
            case 'retiro_enviado':
                iconClass = 'fa-money-bill-wave';
                gradientColor = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                break;
            case 'seguimiento_actualizado':
                iconClass = 'fa-shipping-fast';
                gradientColor = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                break;
            case 'sistema':
                iconClass = 'fa-info-circle';
                gradientColor = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                break;
            default:
                iconClass = 'fa-bell';
        }
        
        iconElement.classList.add(iconClass);
        headerElement.style.background = gradientColor;
    }
    
    /**
     * Maneja el clic en el bot√≥n Aceptar
     */
    async function handleAcceptNotification() {
        if (isProcessing || !currentNotificationId) return;
        
        isProcessing = true;
        const acceptBtn = document.getElementById('acceptNotificationBtn');
        
        try {
            // Deshabilitar el bot√≥n y mostrar loading
            if (acceptBtn) {
                acceptBtn.disabled = true;
                acceptBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
            }
            
            // Marcar la notificaci√≥n como le√≠da
            const response = await fetch('/api/notifications/mark-read/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    notification_id: currentNotificationId
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Cerrar el modal
                if (notificationModal) {
                    notificationModal.hide();
                }
                
                // Actualizar el badge de notificaciones si existe
                updateNotificationBadge();
                
                // Mostrar feedback
                console.log('‚úì Notificaci√≥n marcada como le√≠da');
                
            } else {
                console.error('Error al marcar notificaci√≥n:', data.error);
                alert('Hubo un error al procesar la notificaci√≥n. Por favor, int√©ntalo de nuevo.');
            }
            
        } catch (error) {
            console.error('Error al marcar notificaci√≥n como le√≠da:', error);
            alert('Error de conexi√≥n. Por favor, verifica tu conexi√≥n a internet.');
        } finally {
            isProcessing = false;
            
            // Restaurar el bot√≥n
            if (acceptBtn) {
                acceptBtn.disabled = false;
                acceptBtn.innerHTML = '<i class="fas fa-check me-2"></i>Aceptar';
            }
        }
    }
    
    /**
     * Actualiza el badge de notificaciones en el header
     */
    function updateNotificationBadge() {
        // Recargar las notificaciones del sistema principal
        if (window.notificationSystem && typeof window.notificationSystem.loadNotifications === 'function') {
            window.notificationSystem.loadNotifications();
        }
    }
    
    /**
     * Obtiene el token CSRF
     */
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
               document.querySelector('meta[name=csrf-token]')?.content || '';
    }
    
    /**
     * Tracking de analytics
     */
    function trackNotificationView(notification) {
        if (window.ecoAnalytics) {
            window.ecoAnalytics.trackEvent('notification_modal_shown', {
                notification_id: notification.id,
                notification_type: notification.tipo_original || notification.tipo
            });
        }
    }
    
    // Inicializar el sistema
    initNotificationModal();
    
})();
</script>
